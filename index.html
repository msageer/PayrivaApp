<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payriva Digital Services</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Existing styles remain unchanged */
    </style>
</head>
<body>
    <div class="container">
        <!-- Header, ads panel, tabs, and services section -->
        <!-- All existing HTML remains unchanged -->

        <!-- Data Subscription Form -->
        <div id="dataService" class="service-detail">
            <h2>Buy Mobile Data</h2>
            <form id="dataForm">
                <select name="provider" class="input" id="dataProvider">
                    <option value="">Select Provider</option>
                    <option value="MTN">MTN</option>
                    <option value="Airtel">Airtel</option>
                    <option value="Glo">Glo</option>
                    <option value="9mobile">9Mobile</option>
                </select>
                <input type="tel" placeholder="Phone Number" class="input" id="dataPhone">
                <select name="package" class="input" id="dataPackage">
                    <option value="">Select Package</option>
                </select>
                <div class="currency-info">
                    <span>Price: <span id="dataPriceNGN">0</span> NGN</span>
                    <span>â‰ˆ <span id="dataPriceCrypto">0</span> <span id="selectedCurrency">USDT</span></span>
                </div>
                <select name="paymentMethod" class="input" id="dataPaymentMethod">
                    <option value="USDT">Pay with USDT</option>
                    <option value="TON">Pay with TON</option>
                    <option value="NOTcoin">Pay with NOTcoin</option>
                </select>
                <button type="submit" class="btn">Buy Now</button>
            </form>
        </div>
    </div>

    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();

        // Service package selection logic
        document.getElementById('dataProvider').addEventListener('change', async function () {
            const provider = this.value;
            const packageSelect = document.getElementById('dataPackage');
            packageSelect.innerHTML = '<option value="">Select Package</option>';

            if (!provider) return;

            try {
                // Fetch packages from backend
                const response = await fetch(`/api/packages?provider=${provider}`);
                const packages = await response.json();

                packages.forEach(pkg => {
                    const option = document.createElement('option');
                    option.value = pkg.PRODUCT_CODE;
                    option.textContent = pkg.PRODUCT_NAME;
                    option.setAttribute('data-price', pkg.PRODUCT_AMOUNT);
                    packageSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching packages:', error);
                tg.showPopup({
                    title: "Error",
                    message: "Failed to load packages. Please try again later.",
                    buttons: [{ type: "ok" }]
                });
            }
        });

        // Price update logic
        document.getElementById('dataPackage').addEventListener('change', function () {
            const selectedOption = this.options[this.selectedIndex];
            const priceNGN = selectedOption.getAttribute('data-price');
            const paymentMethod = document.getElementById('dataPaymentMethod').value;

            document.getElementById('dataPriceNGN').textContent = priceNGN;
            document.getElementById('dataPriceCrypto').textContent = convertNGNToCrypto(priceNGN, paymentMethod);
            document.getElementById('selectedCurrency').textContent = paymentMethod;
        });

        document.getElementById('dataPaymentMethod').addEventListener('change', function () {
            const priceNGN = document.getElementById('dataPriceNGN').textContent;
            document.getElementById('dataPriceCrypto').textContent = convertNGNToCrypto(priceNGN, this.value);
            document.getElementById('selectedCurrency').textContent = this.value;
        });

        // Handle form submission
        document.getElementById('dataForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const provider = document.getElementById('dataProvider').value;
            const phone = document.getElementById('dataPhone').value;
            const packageCode = document.getElementById('dataPackage').value;
            const paymentMethod = document.getElementById('dataPaymentMethod').value;

            if (!provider || !phone || !packageCode) {
                tg.showPopup({
                    title: "Missing Information",
                    message: "Please fill in all required fields.",
                    buttons: [{ type: "ok" }]
                });
                return;
            }

            try {
                // Show processing popup
                tg.showPopup({
                    title: "Processing",
                    message: "Please wait while we process your payment...",
                    buttons: []
                });

                // Send request to backend
                const response = await fetch('/api/buy-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mobileNetwork: provider,
                        dataPlan: packageCode,
                        mobileNumber: phone,
                        paymentMethod
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    tg.showPopup({
                        title: "Success",
                        message: "Your data purchase was successful!",
                        buttons: [{ type: "ok" }]
                    });
                } else {
                    tg.showPopup({
                        title: "Error",
                        message: result.message || "Failed to process your request.",
                        buttons: [{ type: "ok" }]
                    });
                }
            } catch (error) {
                console.error('Error processing payment:', error);
                tg.showPopup({
                    title: "Error",
                    message: "An unexpected error occurred. Please try again later.",
                    buttons: [{ type: "ok" }]
                });
            }
        });

        // Helper function to convert NGN to crypto
        function convertNGNToCrypto(amountNGN, cryptoCurrency) {
            const rates = {
                USDT: 750, // Example rate: 1 USDT = 750 NGN
                TON: 4000, // Example rate: 1 TON = 4000 NGN
                NOTcoin: 0.5 // Example rate: 1 NOTcoin = 0.5 NGN
            };
            return (amountNGN / rates[cryptoCurrency]).toFixed(6);
        }
    </script>
</body>
</html>
